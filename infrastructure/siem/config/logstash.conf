# HADEROS Logstash Pipeline Configuration
# Security Event Processing and Enrichment

input {
  # =============================================================================
  # Beats Input (Filebeat, Metricbeat, etc.)
  # =============================================================================
  beats {
    port => 5044
    ssl => false
    tags => ["beats"]
  }

  # =============================================================================
  # TCP Input for Application Logs
  # =============================================================================
  tcp {
    port => 5000
    codec => json_lines
    tags => ["application"]
  }

  # =============================================================================
  # HTTP Input for Webhooks
  # =============================================================================
  http {
    port => 8080
    codec => json
    tags => ["webhook"]
  }
}

filter {
  # =============================================================================
  # Parse JSON Application Logs
  # =============================================================================
  if "application" in [tags] {
    json {
      source => "message"
      target => "parsed"
    }

    # Extract common fields
    mutate {
      add_field => {
        "app_name" => "%{[parsed][app]}"
        "log_level" => "%{[parsed][level]}"
        "log_message" => "%{[parsed][message]}"
      }
    }
  }

  # =============================================================================
  # Security Event Detection
  # =============================================================================

  # Detect Authentication Events
  if [message] =~ /(?i)(login|logout|auth|authentication|signin|signout)/ {
    mutate {
      add_tag => ["security", "authentication"]
    }

    # Failed login detection
    if [message] =~ /(?i)(failed|error|invalid|denied|unauthorized)/ {
      mutate {
        add_tag => ["security_alert", "failed_auth"]
        add_field => { "security_severity" => "medium" }
      }
    }
  }

  # Detect Privilege Escalation Attempts
  if [message] =~ /(?i)(admin|root|sudo|privilege|escalat|permission)/ {
    mutate {
      add_tag => ["security", "privilege"]
    }

    if [message] =~ /(?i)(denied|failed|unauthorized|forbidden)/ {
      mutate {
        add_tag => ["security_alert", "privilege_escalation_attempt"]
        add_field => { "security_severity" => "high" }
      }
    }
  }

  # Detect SQL Injection Attempts
  if [message] =~ /(?i)(union\s+select|or\s+1\s*=\s*1|drop\s+table|insert\s+into|delete\s+from|update\s+.*\s+set)/ {
    mutate {
      add_tag => ["security_alert", "sql_injection"]
      add_field => { "security_severity" => "critical" }
    }
  }

  # Detect XSS Attempts
  if [message] =~ /<script|javascript:|on\w+\s*=|eval\(|document\.cookie/ {
    mutate {
      add_tag => ["security_alert", "xss_attempt"]
      add_field => { "security_severity" => "high" }
    }
  }

  # Detect Path Traversal Attempts
  if [message] =~ /\.\.\// or [message] =~ /\.\.\\/ {
    mutate {
      add_tag => ["security_alert", "path_traversal"]
      add_field => { "security_severity" => "high" }
    }
  }

  # Detect Rate Limiting Events
  if [message] =~ /(?i)(rate.?limit|too.?many.?requests|429|throttl)/ {
    mutate {
      add_tag => ["security", "rate_limit"]
      add_field => { "security_severity" => "low" }
    }
  }

  # Detect API Key/Secret Exposure
  if [message] =~ /(?i)(api.?key|secret|token|password|credential).*(?:=|:)\s*['\"]?[a-zA-Z0-9]{20,}/ {
    mutate {
      add_tag => ["security_alert", "potential_secret_exposure"]
      add_field => { "security_severity" => "critical" }
    }
  }

  # =============================================================================
  # GeoIP Enrichment
  # =============================================================================
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
      add_tag => ["geoip"]
    }
  }

  # =============================================================================
  # User Agent Parsing
  # =============================================================================
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }

  # =============================================================================
  # Timestamp Normalization
  # =============================================================================
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
    target => "@timestamp"
  }

  # =============================================================================
  # Add HADEROS Metadata
  # =============================================================================
  mutate {
    add_field => {
      "[@metadata][index_prefix]" => "haderos"
      "environment" => "${HADEROS_ENV:production}"
    }
  }

  # Set index based on event type
  if "security_alert" in [tags] {
    mutate {
      replace => { "[@metadata][index_prefix]" => "haderos-security-alerts" }
    }
  } else if "security" in [tags] {
    mutate {
      replace => { "[@metadata][index_prefix]" => "haderos-security" }
    }
  } else if "application" in [tags] {
    mutate {
      replace => { "[@metadata][index_prefix]" => "haderos-app" }
    }
  }
}

output {
  # =============================================================================
  # Elasticsearch Output
  # =============================================================================
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS:http://elasticsearch:9200}"]
    user => "${ELASTICSEARCH_USERNAME:elastic}"
    password => "${ELASTICSEARCH_PASSWORD}"
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"

    # ILM (Index Lifecycle Management)
    ilm_enabled => true
    ilm_rollover_alias => "%{[@metadata][index_prefix]}"
    ilm_pattern => "000001"
    ilm_policy => "haderos-security-policy"
  }

  # =============================================================================
  # Security Alerts to Dedicated Index
  # =============================================================================
  if "security_alert" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:http://elasticsearch:9200}"]
      user => "${ELASTICSEARCH_USERNAME:elastic}"
      password => "${ELASTICSEARCH_PASSWORD}"
      index => "haderos-alerts-%{+YYYY.MM.dd}"
    }
  }

  # =============================================================================
  # Debug Output (Development Only)
  # =============================================================================
  if "${HADEROS_ENV:production}" == "development" {
    stdout {
      codec => rubydebug
    }
  }
}
